FROM node:24-trixie-slim

WORKDIR /app

# Install deps first for better layer caching
COPY package*.json ./
RUN npm ci --omit=dev

# Copy source
COPY . .
# ---------- SSH enablement for App Service custom containers ----------
# 1) Install openssh-server   
RUN apt-get update && apt-get install -y --no-install-recommends openssh-server && rm -rf /var/lib/apt/lists/*
# 2) Create directories for sshd (App Service expects config under /home/etc/ssh)
RUN mkdir -p /home/etc/ssh /home/var/run/sshd
# 3) Provide a strict sshd_config (port 2222, no password auth)
#    You can bake this into the image by using a here-doc or COPY from repo
RUN printf "Port 2222\nListenAddress 0.0.0.0\nProtocol 2\nHostKey /home/etc/ssh/ssh_host_rsa_key\nPermitRootLogin prohibit-password\nPasswordAuthentication no\nChallengeResponseAuthentication no\nUsePAM no\nAllowTcpForwarding yes\nGatewayPorts no\nX11Forwarding no\nSubsystem sftp /usr/lib/openssh/sftp-server\n" > /home/etc/ssh/sshd_config
# 4) Generate host keys (stored under /home to survive container restarts in App Service)
RUN ssh-keygen -t rsa -b 4096 -f /home/etc/ssh/ssh_host_rsa_key -N ""

# Runtime env
ENV NODE_ENV=production
ENV PORT=80

EXPOSE 80 2222


RUN apk add --no-cache curl openssh

# Minimal SSH config scoped to /home to avoid touching system defaults
RUN mkdir -p /home/etc/ssh && \
    printf "Port 2222\nUsePrivilegeSeparation no\nPasswordAuthentication no\nPermitRootLogin prohibit-password\nSubsystem sftp /usr/lib/ssh/sftp-server\n" > /home/etc/ssh/sshd_config

# Healthcheck (unchanged)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -fsS http://localhost:80/health || exit 1

# 6) Simple startup script: launch sshd and your node app
#    Adjust "node index.js" if your actual entry differs
RUN printf "#!/bin/sh\nset -e\n/usr/sbin/sshd -D -f /home/etc/ssh/sshd_config -p 2222 &\nexec node index.js\n" > /home/startup.sh \
    && chmod +x /home/startup.sh
# Run the startup script
CMD ["/home/startup.sh"]
